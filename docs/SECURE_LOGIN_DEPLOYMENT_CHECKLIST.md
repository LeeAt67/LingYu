# Neo 安全登录功能 - 生产环境部署检查清单

## 📋 部署前检查清单

使用本清单确保安全登录功能在生产环境中正确配置和部署。

---

## 🔐 安全配置

### 环境变量

- [ ] `JWT_SECRET` 已设置为强随机字符串（至少 32 字符）
- [ ] `DATABASE_URL` 使用生产数据库连接
- [ ] `NODE_ENV` 设置为 `production`
- [ ] 所有敏感信息从代码中移除
- [ ] `.env` 文件不在版本控制中

### 密码安全

- [ ] bcrypt salt rounds 设置为 10 或更高
- [ ] 密码强度验证已启用
- [ ] 密码最小长度为 8 字符
- [ ] 密码复杂度要求已实施

### 令牌管理

- [ ] JWT 访问令牌有效期设置合理（建议 7 天）
- [ ] 刷新令牌有效期设置合理（建议 30 天）
- [ ] 令牌黑名单机制已启用
- [ ] 生产环境使用 Redis 存储黑名单（而非内存）

---

## 🛡️ 中间件配置

### 速率限制

- [ ] 登录端点速率限制已启用（5 次/15 分钟）
- [ ] 速率限制基于 IP 地址
- [ ] 考虑使用 Redis 存储速率限制数据
- [ ] 返回正确的 429 状态码和 retry-after 头

### 安全头

- [ ] Helmet 中间件已配置
- [ ] CSP（内容安全策略）已设置
- [ ] HSTS（HTTP 严格传输安全）已启用
- [ ] X-Frame-Options 已设置
- [ ] X-Content-Type-Options 已设置

### 输入验证

- [ ] XSS 防护已启用
- [ ] SQL 注入防护已启用（使用 Prisma ORM）
- [ ] 输入清理中间件已配置
- [ ] 文件上传限制已设置（如适用）

---

## 🔒 认证和授权

### 认证流程

- [ ] 登录失败使用通用错误消息
- [ ] 密码验证使用恒定时间比较
- [ ] 成功登录后重置速率限制计数
- [ ] lastLoginAt 字段正确更新

### 令牌验证

- [ ] 所有受保护端点使用认证中间件
- [ ] 令牌过期正确处理
- [ ] 令牌黑名单检查已实施
- [ ] 刷新令牌机制正常工作

### 密码重置

- [ ] 重置令牌有效期为 1 小时
- [ ] 重置令牌只能使用一次
- [ ] 重置成功后所有会话失效
- [ ] 生产环境通过邮件发送令牌（不在响应中返回）

---

## 📊 数据库

### 迁移

- [ ] 所有数据库迁移已执行
- [ ] Prisma Client 已生成
- [ ] 数据库连接使用 SSL
- [ ] 数据库备份策略已制定

### 数据完整性

- [ ] 用户邮箱字段唯一索引已创建
- [ ] 外键约束正确设置
- [ ] 敏感字段（密码）不在查询中返回
- [ ] 数据库访问权限最小化

---

## 🌐 网络和基础设施

### HTTPS

- [ ] 生产环境强制使用 HTTPS
- [ ] SSL/TLS 证书有效且未过期
- [ ] HTTP 自动重定向到 HTTPS
- [ ] 证书自动续期已配置

### CORS

- [ ] CORS 策略正确配置
- [ ] 只允许信任的域名
- [ ] 凭证（credentials）正确处理
- [ ] 预检请求正确响应

### 反向代理

- [ ] Nginx/Apache 正确配置
- [ ] X-Forwarded-For 头正确处理
- [ ] 请求大小限制已设置
- [ ] 超时设置合理

---

## 📝 日志和监控

### 日志记录

- [ ] 错误日志正确记录
- [ ] 敏感信息不记录到日志
- [ ] 日志级别设置为 `error` 或 `warn`
- [ ] 日志轮转已配置

### 监控指标

- [ ] 登录成功/失败率监控
- [ ] 速率限制触发监控
- [ ] API 响应时间监控
- [ ] 数据库连接池监控

### 告警

- [ ] 异常登录活动告警
- [ ] 高错误率告警
- [ ] 服务器资源告警
- [ ] 数据库性能告警

---

## 🧪 测试验证

### 单元测试

- [ ] 所有单元测试通过（129 个测试）
- [ ] 测试覆盖率 > 80%
- [ ] 边界条件测试完整
- [ ] 错误处理测试完整

### 集成测试

- [ ] 注册流程端到端测试
- [ ] 登录流程端到端测试
- [ ] 密码重置流程端到端测试
- [ ] 令牌刷新流程测试

### 安全测试

- [ ] XSS 攻击测试
- [ ] SQL 注入测试
- [ ] CSRF 攻击测试
- [ ] 暴力破解测试
- [ ] 令牌伪造测试

---

## 🚀 部署流程

### 部署前

- [ ] 代码审查已完成
- [ ] 所有测试通过
- [ ] 依赖包已更新到稳定版本
- [ ] 安全漏洞扫描已完成

### 部署步骤

1. [ ] 备份生产数据库
2. [ ] 停止旧版本服务（或使用蓝绿部署）
3. [ ] 拉取最新代码
4. [ ] 安装依赖 `pnpm install --production`
5. [ ] 执行数据库迁移 `pnpm run db:push`
6. [ ] 构建前端 `pnpm run build`
7. [ ] 启动新版本服务
8. [ ] 验证服务健康状态
9. [ ] 监控错误日志

### 部署后验证

- [ ] 健康检查端点响应正常
- [ ] 登录功能正常
- [ ] 注册功能正常
- [ ] 密码重置功能正常
- [ ] API 响应时间正常
- [ ] 数据库连接正常

---

## 🔄 回滚计划

### 回滚触发条件

- [ ] 关键功能失败
- [ ] 错误率超过阈值
- [ ] 性能严重下降
- [ ] 安全漏洞发现

### 回滚步骤

1. [ ] 停止新版本服务
2. [ ] 恢复旧版本代码
3. [ ] 回滚数据库迁移（如需要）
4. [ ] 启动旧版本服务
5. [ ] 验证服务恢复正常
6. [ ] 通知相关人员

---

## 📚 文档和培训

### 文档完整性

- [ ] API 文档已更新
- [ ] 部署文档已更新
- [ ] 故障排除指南已准备
- [ ] 安全最佳实践文档已准备

### 团队培训

- [ ] 开发团队了解新功能
- [ ] 运维团队了解部署流程
- [ ] 支持团队了解常见问题
- [ ] 安全团队了解安全措施

---

## 🔍 合规性检查

### 数据保护

- [ ] GDPR 合规（如适用）
- [ ] 用户数据加密存储
- [ ] 数据访问日志记录
- [ ] 数据删除机制已实施

### 隐私政策

- [ ] 隐私政策已更新
- [ ] 用户协议已更新
- [ ] Cookie 政策已更新
- [ ] 数据处理协议已签署

---

## 📞 应急联系

### 关键人员

- [ ] 技术负责人联系方式已记录
- [ ] 运维负责人联系方式已记录
- [ ] 安全负责人联系方式已记录
- [ ] 产品负责人联系方式已记录

### 应急流程

- [ ] 紧急回滚流程已文档化
- [ ] 安全事件响应流程已准备
- [ ] 数据恢复流程已测试
- [ ] 通信渠道已建立

---

## ✅ 最终确认

- [ ] 所有检查项已完成
- [ ] 部署文档已归档
- [ ] 监控告警已配置
- [ ] 团队已准备就绪
- [ ] 用户通知已发送（如需要）

---

**部署日期：** ******\_\_\_******  
**部署人员：** ******\_\_\_******  
**审核人员：** ******\_\_\_******  
**签字确认：** ******\_\_\_******

---

## 📝 备注

记录任何特殊情况、已知问题或需要后续跟进的事项：

```
[在此添加备注]
```

---

**文档版本：** 1.0.0  
**最后更新：** 2024 年 12 月 28 日
