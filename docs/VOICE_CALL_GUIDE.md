# 语音通话功能使用指南

## 功能概述

Neo 平台集成了实时 AI 语音通话功能，支持与 AI 助手进行自然的语音对话。该功能基于阿里云 Qwen-Omni 模型，提供：

- 🎤 实时语音输入和识别
- 🔊 AI 语音回复播放
- 📝 实时转录显示
- 🛑 语音打断功能
- 💾 对话历史保存
- 📊 音频可视化

## 快速开始

### 1. 配置 API 密钥

在`Neo/server/.env`文件中配置阿里云 DashScope API 密钥：

```bash
# 从 https://dashscope.console.aliyun.com/ 获取API密钥
DASHSCOPE_API_KEY=your-dashscope-api-key-here
REALTIME_MODEL=qwen3-omni-flash-realtime
REALTIME_BASE=wss://dashscope.aliyuncs.com/api-ws/v1/realtime
```

### 2. 启动服务

```bash
# 启动后端服务
cd Neo/server
pnpm install
pnpm run dev

# 启动前端服务（新终端）
cd Neo/client
pnpm install
pnpm run dev
```

### 3. 使用语音通话

1. 登录 Neo 平台
2. 进入任意聊天会话
3. 点击顶部导航栏的**电话图标**按钮
4. 允许浏览器访问麦克风权限
5. 开始语音对话

## 功能详解

### 语音输入

- **自动语音识别**：系统会自动识别你的语音并转换为文字
- **实时传输**：音频数据以 200ms 为单位实时传输到 AI 模型
- **VAD 检测**：客户端语音活动检测，优化传输效率

### AI 语音回复

- **自然语音**：AI 使用自然流畅的语音回复
- **实时播放**：音频流式接收并播放，无需等待完整响应
- **转录显示**：AI 回复的文字实时显示在界面上

### 语音打断

当 AI 正在说话时，你可以随时开口打断：

1. 系统检测到你的语音
2. 立即停止 AI 音频播放
3. 清空播放队列
4. 发送打断信号到后端
5. AI 停止当前回复，准备接收新输入

### 音频可视化

- **输入波形**：实时显示你的语音波形
- **输出波形**：显示 AI 回复的音频波形
- **状态指示**：清晰显示麦克风状态和 AI 说话状态

### 控制功能

- **静音/取消静音**：临时关闭/开启麦克风
- **结束通话**：关闭语音连接，保存对话历史
- **全屏模式**：切换窗口/全屏显示

### 对话历史

所有语音对话都会自动保存到数据库：

- 用户语音转录
- AI 回复转录
- 会话时长
- 时间戳

可以在聊天历史中查看完整的语音对话记录。

## 浏览器兼容性

### 推荐浏览器

- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 88+
- ⚠️ Safari 14+（部分功能可能受限）

### 必需权限

- 麦克风访问权限
- WebSocket 连接权限

## 常见问题

### 1. 无法访问麦克风

**问题**：点击开始通话后提示"无法访问麦克风"

**解决方案**：

- 检查浏览器是否允许麦克风权限
- 确保没有其他应用占用麦克风
- 尝试刷新页面重新授权

### 2. 连接失败

**问题**：显示"WebSocket 连接失败"

**解决方案**：

- 检查后端服务是否正常运行
- 确认`.env`文件中的 API 密钥配置正确
- 检查网络连接是否正常
- 查看浏览器控制台的错误信息

### 3. AI 无响应

**问题**：说话后 AI 没有回复

**解决方案**：

- 检查 API 密钥是否有效
- 确认 DashScope 账户余额充足
- 查看后端日志是否有错误信息
- 尝试结束通话后重新开始

### 4. 音频播放卡顿

**问题**：AI 语音播放不流畅

**解决方案**：

- 检查网络连接质量
- 关闭其他占用带宽的应用
- 尝试降低浏览器标签页数量
- 清理浏览器缓存

### 5. 打断功能不工作

**问题**：说话时无法打断 AI

**解决方案**：

- 确保麦克风正常工作
- 说话音量要足够大
- 检查 VAD 检测是否启用
- 尝试重新开始通话

## 代理配置（可选）

如果需要通过代理访问阿里云 API，在`.env`中配置：

```bash
HTTP_PROXY=http://proxy.example.com:8080
HTTPS_PROXY=http://proxy.example.com:8080
```

## 技术架构

### 前端组件

- `VoiceCallPanel.tsx` - 主面板组件
- `VoiceCallModal.tsx` - 模态框包装器
- `AudioVisualizer.tsx` - 音频可视化
- `ControlBar.tsx` - 控制按钮
- `SubtitlePanel.tsx` - 转录显示

### 音频处理

- `RealtimeWsClient.ts` - WebSocket 客户端
- `AudioStreamer.ts` - 音频捕获和编码
- `PcmPlayer.ts` - PCM 音频播放

### 状态管理

- `useVoiceCallStore.ts` - Zustand 状态管理

### 后端服务

- `voiceProxy.ts` - WebSocket 代理服务
- `voiceChat.ts` - REST API 路由

### 数据模型

- `VoiceSession` - 语音会话
- `VoiceMessage` - 语音消息

## 性能优化建议

1. **音频缓冲**：默认 200ms 缓冲，可根据网络情况调整
2. **采样率**：输入 16kHz，输出 24kHz，平衡质量和带宽
3. **VAD 模式**：启用客户端 VAD，减少无效传输
4. **连接复用**：保持 WebSocket 连接，避免频繁重连

## 安全注意事项

1. **API 密钥保护**：不要将 API 密钥提交到版本控制
2. **用户认证**：语音通话需要用户登录
3. **数据加密**：WebSocket 使用 WSS 加密传输
4. **权限验证**：后端验证用户身份和会话权限

## 更新日志

### v1.0.0 (2024-12-28)

- ✨ 初始版本发布
- 🎤 实时语音输入和识别
- 🔊 AI 语音回复播放
- 🛑 语音打断功能
- 💾 对话历史保存
- 📊 音频可视化

## 反馈与支持

如有问题或建议，请联系开发团队或提交 Issue。
